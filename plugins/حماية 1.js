import fs from 'fs';

let handler = async (m, { conn, usedPrefix, command }) => {
  // ุชูุงุนู ุฅูููุฌู ูุจู ุงูุฅุฑุณุงู
  await conn.sendMessage(m.chat, {
    react: {
      text: "โ๏ธ",
      key: m.key,
    }
  });

  // ูุนูููุงุช ุงููุฌููุนุฉ
  const groupMetadata = await conn.groupMetadata(m.chat);
  const owner = groupMetadata.owner;
  const developerNumber = "201222784295@s.whatsapp.net"; // ุงุณุชุจุฏู ุจุฑููู
  const botNumber = conn.user.jid; // ุฑูู ุงูุจูุช ููุณู

  try {
    // ุงูุชุฃูุฏ ุฃู ุงูุจูุช ูุฏูู ุตูุงุญูุงุช ุงููุดุฑู ูุจู ุงูุชูููุฐ
    const botIsAdmin = groupMetadata.participants.find(p => p.id === botNumber)?.admin;
    if (!botIsAdmin) {
      return conn.sendMessage(m.chat, { text: 'โ *ูุฌุจ ุฃู ูููู ุงูุจูุช ูุดุฑููุง ูุงุณุชุฎุฏุงู ูุฐุง ุงูุฃูุฑ!*' }, { quoted: m });
    }

    // ุฌูุจ ูุงุฆูุฉ ุงูุฃุนุถุงุก
    const participants = groupMetadata.participants;

    // ุชุตููุฉ ุงูุฃุนุถุงุก ุงูุฐูู ุณูุฒูู ุตูุงุญูุงุชูู (ูุน ุงุณุชุซูุงุก ุงูุจูุช ูุงููุทูุฑ ูุงููุคุณุณ)
    const membersToDemote = participants.filter(user => 
      user.id !== owner && 
      user.id !== developerNumber && 
      user.id !== botNumber && // ุงุณุชุซูุงุก ุงูุจูุช
      user.admin
    ).map(user => user.id);
    
    // ุฅุฒุงูุฉ ุงูุตูุงุญูุงุช
    if (membersToDemote.length > 0) {
      await conn.groupParticipantsUpdate(m.chat, membersToDemote, 'demote');

      // ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฃููุฏ ูุน ุงูุฒุฎุงุฑู
      await conn.sendMessage(m.chat, { 
        text: `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*\n\n` +
              `โโ *ุชู ุฑุตุฏ ูุญุงููุฉ ุฒุฑู ุงููุฌููุนุฉ!*\n\n` +
              `โโ ูุฐูู ููุช ุจุงุฒุงูุฉ ุฅุดุฑุงู ${membersToDemote.length} ูุดุฑู\n` +
              `โโ ุงูุฃุนุถุงุก ุงููุญูููู:\n` +
              `โข ๐ *ุงููุคุณุณ*\n` +
              `โข ๐ *ุงููุทูุฑ (+201222784295)*\n` +
              `โข ๐ค *โฆโ๐๐๐๐๐๐๐๐ |โ| ๐๐๐โโฆ*\n\n` +
              `โโ ุชู ุชูููุฐ ุงูุฃูุฑ ูุญูุงูุฉ ุงููุฌููุนุฉ ูู ุงูุฒุฑู!\n\n` +
              `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*`,
        mentions: [owner, developerNumber, botNumber]
      }, { quoted: m });

    } else {
      await conn.sendMessage(m.chat, { 
        text: `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*\n\n` +
              `โโ *ูุง ููุฌุฏ ูุดุฑููู ูุฅุฒุงูุฉ ุตูุงุญูุงุชูู!*\n\n` +
              `โโ ุงูุฃุนุถุงุก ุงููุญูููู:\n` +
              `โข ๐ *ุงููุคุณุณ*\n` +
              `โข ๐ *ุงููุทูุฑ (+201222784295)*\n` +
              `โข ๐ค *โฆโ๐๐๐๐๐๐๐๐ |โ| ๐๐๐โโฆ*\n\n` +
              `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*`,
        mentions: [owner, developerNumber, botNumber]
      }, { quoted: m });
    }

    // ุฅุฑุณุงู ุงูููุทุน ุงูุตูุชู ูู ุงููุฌูุฏ ุงููุญูู
    const audioPath = './media/ุงูู.mp3';
    if (fs.existsSync(audioPath)) {
      await conn.sendMessage(m.chat, { 
        audio: fs.readFileSync(audioPath), 
        mimetype: 'audio/mpeg',
        ptt: false 
      }, { quoted: m });
    } else {
      await conn.sendMessage(m.chat, { text: 'โ๏ธ *ุงูููุทุน ุงูุตูุชู ุบูุฑ ููุฌูุฏ ูู ุงููุณุงุฑ ุงููุญุฏุฏ!*' }, { quoted: m });
    }

  } catch (error) {
    console.error(error);
    await conn.sendMessage(m.chat, { 
      text: `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*\n\n` +
            `โ *ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูููุฐ!*\n\n` +
            `โข ุงูุฎุทุฃ: ${error.message}\n\n` +
            `*โโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโอโโชโกโซโโโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโ๏ธฉ๏ธชเนโโ*`
    }, { quoted: m });
  }
}

// ูุนูููุงุช ุงููุณุงุนุฏุฉ
handler.help = ['ุฒุฑู', 'ุจูู', 'ุชูุฌูุฑ', 'ุทุฑุฏ_ุงููู', 'ุทุฑุฏ-ุงููู'];
handler.tags = ['group'];

// ุงูุฃูุงูุฑ ุงููุณููุญุฉ
handler.command = /^(ุฒุฑู|ุจูู|ุชูุฌูุฑ|ุทุฑุฏ_ุงููู|ุทุฑุฏ-ุงููู)$/i;

// ูุชุทูุจุงุช ุงูุชุดุบูู
handler.group = true;
handler.botAdmin = true;
handler.owner = false; // ูุง ูููู ูููุงูู ุงุณุชุฎุฏุงูู ุฅูุง ุฅุฐุง ูุงู ุงูุจูุช ูุดุฑููุง
handler.admin = false; // ูุง ูููู ูููุดุฑููู ุงูุนุงุฏููู ุงุณุชุฎุฏุงูู

export default handler;