import { canLevelUp } from '../lib/levelling.js';
import axios from 'axios';

export async function before(m, { conn }) {
    let user = global.db.data.users[m.sender];
    if (!user) return;

    if (!('autolevelup' in user)) user.autolevelup = true;
    if (!user.autolevelup) return;

    let before = user.level;
    while (canLevelUp(user.level, user.exp, global.multiplier)) {
        user.level++;
    }

    const roles = [
        'Ø¹Ø¶Ùˆ Ø¹ØµØ§Ø¨Ø© Ù…Ø¨ØªØ¯Ø¦ğŸ•µï¸â€â™‚ï¸', 'Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¹ØµØ§Ø¨Ø©ğŸ”«', 'Ù…Ù‚Ø§ØªÙ„ Ø¹ØµØ§Ø¨Ø©ğŸ’£', 'Ø±Ø¬Ù„ Ø¹ØµØ§Ø¨Ø© Ù…Ø®Ø¶Ø±Ù…ğŸ”ª',
        'Ù…Ø³Ø§Ø¹Ø¯ Ø±Ø¦ÙŠØ³ Ø§Ù„Ø¹ØµØ§Ø¨Ø©ğŸ©', 'Ø±Ø¦ÙŠØ³ Ø¹ØµØ§Ø¨Ø© ØµØºÙŠØ±âš¡', 'Ø²Ø¹ÙŠÙ… Ø¹ØµØ§Ø¨Ø© Ø³Ø±ÙŠğŸ”’', 'Ù…Ø¬Ø±Ù… Ù…Ø­ØªØ±ÙğŸ’€',
        'Ø£Ù…ÙŠØ± Ø§Ù„Ø¹ØµØ§Ø¨Ø©ğŸ‘‘', 'Ø²Ø¹ÙŠÙ… Ø¹ØµØ§Ø¨Ø© ÙƒØ¨ÙŠØ±ğŸ’¼', 'Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰ Ù„Ù„Ø²Ø¹ÙŠÙ…ğŸ–¤', 'Ø²Ø¹ÙŠÙ… Ø¹ØµØ§Ø¨Ø© Ù‚ÙˆÙŠâš”ï¸',
        'Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø¹ØµØ§Ø¨Ø§ØªğŸ‘¹', 'Ù…Ù„Ùƒ Ø§Ù„Ø¹ØµØ§Ø¨Ø§ØªğŸŒ‘', 'Ø­Ø§ÙƒÙ… Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ğŸ™ï¸', 'Ø¥Ù„Ù‡ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ğŸ‘ï¸',
        'Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¸Ù„Ø§Ù„ğŸ–¤', 'Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø¹ØµØ§Ø¨Ø©ğŸ’', 'Ù†Ø¬Ù… Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ğŸ’¥', 'Ù…Ù„Ùƒ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ğŸ–¤',
        'Ø£Ù…ÙŠØ± Ø§Ù„Ø¸Ù„Ø§Ù…ğŸŒ™', 'Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©ğŸŒ', 'Ø§Ù„ÙˆØ­Ø´ Ø§Ù„Ø£Ø²Ø±Ù‚ğŸ’€', 'Ù†Ù‚ÙŠØ¨ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©âš ï¸',
        'Ù…Ù„Ùƒ Ø§Ù„Ø¥Ø¬Ø±Ø§Ù… ğŸ°', 'Ø³ÙŠØ¯ Ø§Ù„Ø¹ØµØ§Ø¨Ø§ØªğŸ©', 'Ø£Ù…ÙŠØ± Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ğŸ’¥', 'Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ğŸ¦¹â€â™‚ï¸',
        'Ù…Ù„Ùƒ Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ù…Ø¸Ù„Ù…Ø©ğŸ‘‘', 'Ø³ÙŠØ¯ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©ğŸ–¤', 'Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„ÙÙˆØ¶Ù‰ğŸ‘ï¸', 'Ù…Ù„Ùƒ Ø§Ù„Ø¸Ù„Ø§Ù„ğŸ–¤',
        'Ø£Ø¨ Ø§Ù„ÙÙˆØ¶Ù‰ğŸ‘¹', 'Ø²Ø¹ÙŠÙ… Ø§Ù„Ù„ØµÙˆØµğŸ‘¾', 'Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø³Ø±Ù‚Ø©ğŸ’', 'Ù…Ù„Ùƒ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„Ù…Ø¸Ù„Ù…Ø©ğŸŒ‘',
        'Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¹ØµØ§Ø¨Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ğŸ’£', 'Ù…Ù„Ùƒ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„Ø£Ø®ÙŠØ±âš”ï¸', 'Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø§Ù„Ø¬Ù‡Ù†Ù…ÙŠğŸ”¥', 'Ø¥Ù„Ù‡ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø³ÙÙ„ÙŠğŸ’€',
        'Ù…Ù„Ùƒ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© Ø§Ù„Ø£Ø¨Ø¯ÙŠğŸ’€', 'Ø§Ù„Ø²Ø¹ÙŠÙ… Ø§Ù„Ù…Ø·Ù„Ù‚ Ù„Ù„Ø¹ØµØ§Ø¨Ø§ØªğŸ‘‘'
    ];

    user.role = roles[Math.min(Math.floor(user.level / 2), roles.length - 1)];

    if (before !== user.level) {
        const caption = `
â•­â”€â”ˆâ”âšµâ” â•âŸâ—ˆâŸâ• â”âšµâ”â”ˆâ”€â•®
â•ğŸ…â¯ Ù„Ù‚Ø¯ Ø§Ø±ØªÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ â®ğŸ…â•
â•°â”€â”ˆâ”âšµâ” â•âŸâ—ˆâŸâ• â”âšµâ”â”ˆâ”€â•¯
â•‘ğŸ€„â•‘Ù„Ù€Ù€ÙÙ€Ù„Ù€Ùƒ Ø§Ù„Ù€Ù‚Ù€Ø¯ÙŠÙ€Ù… â—ƒâ—‚â—ƒ âŒˆ${before}âŒ‹ 
â•‘ğŸ´â•‘Ù„Ù€Ù€ÙÙ€Ù„Ù€Ùƒ Ø§Ù„Ù€Ø¬Ù€Ø¯ÙŠÙ€Ø¯ â—ƒâ—‚â—ƒ âŒˆ ${user.level}âŒ‹
â•­â”€â”ˆâ”âšµâ” â•âŸâ—ˆâŸâ• â”âšµâ”â”ˆâ”€â•®
> ÙƒÙ„Ù…Ø§ ØªÙØ§Ø¹Ù„Øª Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª Ø§Ø±ØªÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ
> Ø§ÙƒØªØ¨ #Ù„ÙÙ„ Ù„Ù…Ø¹Ø±ÙÙ‡ Ù…Ø³ØªÙˆØ§Ùƒ
â•°â”€â”ˆâ”âšµâ” â•âŸâ—ˆâŸâ• â”âšµâ”â”ˆâ”€â•¯
`.trim();

        try {
            const imageBuffer = await axios.get('https://tinyurl.com/23cv4gq3', { responseType: 'arraybuffer' });
            await conn.sendMessage(m.chat, {
                image: imageBuffer.data,
                caption,
                mentions: [m.sender]
            }, { quoted: m });
        } catch (err) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:", err);
            await conn.sendMessage(m.chat, {
                text: caption,
                mentions: [m.sender]
            }, { quoted: m });
        }
    }
}

export const disabled = false;